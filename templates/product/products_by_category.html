{% extends "layout.html" %}
{% block title %}{{ category.name if category else "Prekių katalogas" }}{% endblock %}

{% block content %}
<div class="container catalog-container">

    <div class="category-header" style="margin-bottom: 2rem;">
        {% if category %}
            <h2 class="mb-0">{{ category.name }}</h2>
            <a href="{{ url_for('product.product_list') }}" class="btn btn-outline-secondary btn-sm ms-2">
                <span style="font-size: 1.2em;">&#8592;</span> Visos kategorijos
            </a>
        {% endif %}
    </div>

    <!-- Filtrai ir rūšiavimas -->
    <div class="catalog-filters">
        <form method="get" class="filters-form">
            <input type="text" name="q" placeholder="Ieškoti prekių..." value="{{ request.args.get('q', '') }}">
            <select name="sort_by">
                <option value="default" {% if request.args.get('sort_by') == 'default' %}selected{% endif %}>Rikiuoti pagal</option>
                <option value="price_asc" {% if request.args.get('sort_by') == 'price_asc' %}selected{% endif %}>Kaina: nuo mažiausios</option>
                <option value="price_desc" {% if request.args.get('sort_by') == 'price_desc' %}selected{% endif %}>Kaina: nuo didžiausios</option>
                <option value="name_asc" {% if request.args.get('sort_by') == 'name_asc' %}selected{% endif %}>Pavadinimas: A-Z</option>
                <option value="name_desc" {% if request.args.get('sort_by') == 'name_desc' %}selected{% endif %}>Pavadinimas: Z-A</option>
            </select>
            <button type="submit" class="btn filter-btn">Filtruoti</button>
        </form>
    </div>

    <!-- Swiper carousel -->
    <div class="swiper mySwiper">
        <div class="swiper-wrapper">
            {% for product in products %}
            <div class="swiper-slide">
                <div class="product-card">
                    {% if product.discount %}
                        <div class="product-badge discount-badge">-{{ product.discount }}%</div>
                    {% endif %}
                    <div class="product-img-wrap">
                        <img src="{{ url_for('static', filename='uploads/' ~ (product.image_filename or 'default.png')) }}"
                             alt="{{ product.name }}" class="product-img" loading="lazy">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">{{ product.name }}</h3>
                        <div class="product-rating mb-2" aria-label="Vidutinis įvertinimas">
                            {% set avg = avg_ratings[product.id] if avg_ratings[product.id] is not none else 0 %}
                            {% for i in range(1, 6) %}
                                {% if i <= avg|round(0, 'floor') %}
                                    <span class="star filled" aria-hidden="true">&#9733;</span>
                                {% else %}
                                    <span class="star" aria-hidden="true">&#9734;</span>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-count">({{ reviews_count[product.id] if reviews_count[product.id] is not none else 0 }})</span>
                        </div>
                        <div class="product-pricing mb-2">
                            {% if product.discount_price %}
                                <span class="price-old">{{ product.price|round(2) }}€</span>
                                <span class="price-new">{{ product.discount_price|round(2) }}€</span>
                            {% else %}
                                <span class="price-new">{{ product.price|round(2) }}€</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="product-actions">
                        <a href="{{ url_for('product.product_detail', product_id=product.id) }}" class="btn btn-secondary btn-details">Apžiūrėti</a>
                        {% if current_user.is_authenticated %}
                        <form method="POST" action="{{ url_for('cart.add_to_cart', product_id=product.id) }}">
                            {{ forms[product.id].hidden_tag() }}
                            {{ forms[product.id].quantity(type="hidden", value=1) }}
                            {{ forms[product.id].submit(class_="btn btn-primary btn-cart") }}
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="swiper-slide">
                <div class="no-products">
                    Prekių šioje kategorijoje nerasta pagal pasirinktus filtrus.
                </div>
            </div>
            {% endfor %}
        </div>
        <!-- Swiper navigation -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
    </div>
</div>
{% endblock %}